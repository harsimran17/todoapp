<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Todo List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        
        .header-section {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            padding: 2rem 0;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header-title {
            margin: 0;
            font-weight: 600;
            font-size: 2.5rem;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            margin: 0.5rem 0 0 0;
            font-weight: 400;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .header-icon {
            font-size: 2.5rem;
            margin-right: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-right {
            text-align: right;
        }

        .task-count {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .completed-count {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .completed {
            text-decoration: line-through;
            color: #888;
        }
        .todo-container {
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        .calendar-container {
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        #calendar {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .fc {
            max-width: 100%;
        }
        .fc .fc-toolbar {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .fc .fc-toolbar-title {
            font-size: 1.2em;
        }
        .fc .fc-button {
            padding: 0.3rem 0.6rem;
            font-size: 0.9em;
        }
        .fc .fc-daygrid-day {
            min-height: 40px;
        }
        .fc .fc-daygrid-day-number {
            font-size: 0.9em;
            padding: 4px;
        }
        .subtask-item {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .subtask-form {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .add-todo-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .subtask-toggle {
            cursor: pointer;
            color: #007bff;
            text-decoration: none;
        }
        .subtask-toggle:hover {
            text-decoration: underline;
        }
        .subtask-content {
            display: none;
        }
        .subtask-count {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.8em;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <div class="header-content">
            <div class="header-left">
                <i class="fas fa-tasks header-icon"></i>
                <div>
                    <h1 class="header-title">Todo List</h1>
                    <p class="header-subtitle">Organize your tasks efficiently</p>
                </div>
            </div>
            <div class="header-right">
                <p class="task-count" th:with="totalTasks=${#lists.size(todos)}, 
                                              completedTasks=${#lists.size(todos.?[completed])}">
                    <span th:text="${totalTasks}">0</span> Total Tasks
                </p>
                <p class="completed-count">
                    <span th:text="${completedTasks}">0</span> Completed
                </p>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- First Row: Calendar and Todos side by side -->
        <div class="row mb-4">
            <!-- Calendar -->
            <div class="col-md-4">
                <div class="card calendar-container">
                    <div class="card-body">
                        <h5 class="card-title">Calendar</h5>
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>

            <!-- Todo List -->
            <div class="col-md-8">
                <div class="card todo-container">
                    <div class="card-body">
                        <h5 class="card-title">Your Todos</h5>
                        
                        <!-- Date Filter -->
                        <div class="mb-4">
                            <div class="row g-3 align-items-end">
                                <div class="col-auto">
                                    <label for="filterDate" class="form-label">Filter by Date</label>
                                    <input type="date" class="form-control" id="filterDate" 
                                           th:value="${selectedDate != null ? selectedDate : #temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}">
                                </div>
                                <div class="col-auto">
                                    <button onclick="filterByDate()" class="btn btn-primary">Filter</button>
                                    <a th:href="@{/todos}" class="btn btn-secondary">Show All</a>
                                </div>
                            </div>
                        </div>

                        <div th:if="${todos.empty}" class="alert alert-info">
                            No todos found. Add one below!
                        </div>
                        <div th:each="todo : ${todos}" class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title" th:classappend="${todo.completed ? 'completed' : ''}" th:text="${todo.title}"></h5>
                                        <p class="card-text" th:text="${todo.description}"></p>
                                        <small class="text-muted" th:text="${#temporals.format(todo.dueDate, 'yyyy-MM-dd')}"></small>
                                        
                                        <!-- Subtasks Section -->
                                        <div class="mt-3">
                                            <div class="d-flex align-items-center">
                                                <a href="#" class="subtask-toggle" th:onclick="'toggleSubtasks(' + ${todo.id} + ')'">
                                                    <i class="fas fa-chevron-down"></i> Subtasks
                                                </a>
                                                <span class="subtask-count" th:text="${todo.subtasks != null ? todo.subtasks.size() : 0}">0</span>
                                                <button class="btn btn-sm btn-outline-primary ms-2" 
                                                        th:onclick="'toggleAddSubtaskForm(' + ${todo.id} + ')'">
                                                    Add Subtask
                                                </button>
                                            </div>
                                            
                                            <!-- Subtasks Content (Hidden by default) -->
                                            <div class="subtask-content" th:id="'subtasks-' + ${todo.id}">
                                                <div th:if="${todo.subtasks != null and !todo.subtasks.empty}">
                                                    <div th:each="subtask : ${todo.subtasks}" class="subtask-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <span th:classappend="${subtask.completed ? 'completed' : ''}" th:text="${subtask.title}"></span>
                                                                <small class="text-muted d-block" th:text="${subtask.description}"></small>
                                                            </div>
                                                            <div>
                                                                <button class="btn btn-sm" 
                                                                        th:classappend="${subtask.completed ? 'btn-warning' : 'btn-success'}"
                                                                        th:text="${subtask.completed ? 'Undo' : 'Complete'}"
                                                                        th:onclick="'toggleSubtaskStatus(' + ${subtask.id} + ', this)'">
                                                                </button>
                                                                <a th:href="@{/todos/subtasks/{id}/delete(id=${subtask.id})}" class="btn btn-sm btn-danger"
                                                                   onclick="return confirm('Are you sure you want to delete this subtask?')">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div th:if="${todo.subtasks == null or todo.subtasks.empty}" class="text-muted">
                                                    No subtasks yet.
                                                </div>
                                            </div>
                                            
                                            <!-- Add Subtask Form (Hidden by default) -->
                                            <div class="subtask-form" th:id="'add-subtask-form-' + ${todo.id}">
                                                <form th:action="@{/todos/{todoId}/subtasks(todoId=${todo.id})}" th:object="${newSubtask}" method="post">
                                                    <div class="mb-2">
                                                        <input type="text" class="form-control form-control-sm" placeholder="Subtask title" 
                                                               th:field="*{title}" required>
                                                    </div>
                                                    <div class="mb-2">
                                                        <textarea class="form-control form-control-sm" placeholder="Subtask description" 
                                                                  th:field="*{description}" rows="2"></textarea>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button type="submit" class="btn btn-sm btn-primary">Add Subtask</button>
                                                        <button type="button" class="btn btn-sm btn-secondary" 
                                                                th:onclick="'toggleAddSubtaskForm(' + ${todo.id} + ')'">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ms-3">
                                        <a th:href="@{/todos/toggle/{id}(id=${todo.id})}" class="btn btn-sm" 
                                           th:classappend="${todo.completed ? 'btn-warning' : 'btn-success'}"
                                           th:text="${todo.completed ? 'Mark Incomplete' : 'Mark Complete'}">
                                        </a>
                                        <a th:href="@{/todos/edit/{id}(id=${todo.id})}" class="btn btn-sm btn-primary">Edit</a>
                                        <a th:href="@{/todos/delete/{id}(id=${todo.id})}" class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this todo?')">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row: Add New Todo as small centered box -->
        <div class="row">
            <div class="col-12">
                <div class="add-todo-container">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-center">Add New Todo</h5>
                            <form th:action="@{/todos}" th:object="${newTodo}" method="post">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="title" th:field="*{title}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="dueDate" class="form-label">Due Date</label>
                                        <input type="date" class="form-control" id="dueDate" th:field="*{dueDate}" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" th:field="*{description}" rows="1"></textarea>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <button type="submit" class="btn btn-primary">Add Todo</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                height: 'auto',
                dateClick: function(info) {
                    window.location.href = `/todos/date/${info.dateStr}`;
                }
            });
            
            calendar.render();
        });

        function filterByDate() {
            const date = document.getElementById('filterDate').value;
            if (date) {
                window.location.href = `/todos/date/${date}`;
            }
        }

        function toggleSubtasks(todoId) {
            const subtasksContent = document.getElementById('subtasks-' + todoId);
            const toggleButton = event.target.closest('.subtask-toggle');
            const icon = toggleButton.querySelector('i');
            
            if (subtasksContent.style.display === 'none' || subtasksContent.style.display === '') {
                subtasksContent.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                subtasksContent.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function toggleAddSubtaskForm(todoId) {
            const form = document.getElementById('add-subtask-form-' + todoId);
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
                // Clear the form
                form.querySelector('input[type="text"]').value = '';
                form.querySelector('textarea').value = '';
            }
        }

        function toggleSubtaskStatus(subtaskId, buttonElement) {
            fetch(`/todos/subtasks/${subtaskId}/toggle`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    // Toggle the button text and class
                    const button = buttonElement;
                    const isCompleted = button.textContent.trim() === 'Undo';
                    
                    if (isCompleted) {
                        button.textContent = 'Complete';
                        button.className = 'btn btn-sm btn-success';
                        // Remove completed styling from the subtask title
                        const subtaskTitle = button.closest('.subtask-item').querySelector('span');
                        subtaskTitle.classList.remove('completed');
                    } else {
                        button.textContent = 'Undo';
                        button.className = 'btn btn-sm btn-warning';
                        // Add completed styling to the subtask title
                        const subtaskTitle = button.closest('.subtask-item').querySelector('span');
                        subtaskTitle.classList.add('completed');
                    }

                    // Check all subtasks status and update parent todo UI
                    const subtaskContainer = button.closest('.subtask-content');
                    const allSubtaskItems = subtaskContainer.querySelectorAll('.subtask-item');
                    const allCompleted = Array.from(allSubtaskItems).every(item => 
                        item.querySelector('button').textContent.trim() === 'Undo'
                    );

                    // Update parent todo UI
                    const todoCard = button.closest('.card');
                    const todoTitle = todoCard.querySelector('.card-title');
                    const todoToggleButton = todoCard.querySelector('a[href*="/todos/toggle/"]');
                    
                    if (allCompleted) {
                        todoTitle.classList.add('completed');
                        todoToggleButton.textContent = 'Mark Incomplete';
                        todoToggleButton.classList.remove('btn-success');
                        todoToggleButton.classList.add('btn-warning');
                    } else {
                        todoTitle.classList.remove('completed');
                        todoToggleButton.textContent = 'Mark Complete';
                        todoToggleButton.classList.remove('btn-warning');
                        todoToggleButton.classList.add('btn-success');
                    }
                } else {
                    console.error('Failed to toggle subtask status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html> 